# Task: Migrate from Integer IDs to UUIDs

## Overview
Convert all primary and foreign keys from auto-incrementing integers to UUIDs across the entire Phoenix application. This change will eliminate ID collisions between different entity types and provide globally unique identifiers.

## Prerequisites
- All tests should be passing before starting

## 1. Database Schema Changes

### 1.1 Create UUID Extension Migration
```elixir
# priv/repo/migrations/[timestamp]_enable_uuid_extension.exs
defmodule GameMasterCore.Repo.Migrations.EnableUuidExtension do
  use Ecto.Migration

  def up do
    execute "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\""
  end

  def down do
    execute "DROP EXTENSION IF EXISTS \"uuid-ossp\""
  end
end
```

### 1.2 Update Primary Key Migrations
Update all existing table migrations to use UUID primary keys:

**Files to modify:**
- `priv/repo/migrations/20250820121011_create_games.exs`
- `priv/repo/migrations/20250822155841_create_characters.exs`
- `priv/repo/migrations/[timestamp]_create_factions.exs`
- `priv/repo/migrations/[timestamp]_create_locations.exs`
- `priv/repo/migrations/[timestamp]_create_notes.exs`
- `priv/repo/migrations/[timestamp]_create_quests.exs`

**Changes needed:**
```elixir
# Before
def change do
  create table(:games) do
    add :name, :string, null: false
    # ...
  end
end

# After
def change do
  create table(:games, primary_key: false) do
    add :id, :binary_id, primary_key: true
    add :name, :string, null: false
    # ...
  end
end
```

### 1.3 Update Foreign Key Migrations
Update all join table and relationship migrations:

**Files to modify:**
- All `_create_[entity]_[entity]_links.exs` migration files
- Any migration with `references()` calls

**Changes needed:**
```elixir
# Before
add :game_id, references(:games, on_delete: :delete_all)

# After  
add :game_id, references(:games, type: :binary_id, on_delete: :delete_all)
```

## 2. Ecto Schema Updates

### 2.1 Main Entity Schemas
Update all primary entity schemas to use UUIDs:

**Files to modify:**
- `lib/game_master_core/games/game.ex`
- `lib/game_master_core/characters/character.ex`
- `lib/game_master_core/factions/faction.ex`
- `lib/game_master_core/locations/location.ex`
- `lib/game_master_core/notes/note.ex`
- `lib/game_master_core/quests/quest.ex`
- `lib/game_master_core/accounts/user.ex`

**Changes needed:**
```elixir
# Add to top of schema block
@primary_key {:id, :binary_id, autogenerate: true}
@foreign_key_type :binary_id

# Update belongs_to relationships
belongs_to :game, Game, type: :binary_id
belongs_to :user, User, type: :binary_id
```

### 2.2 Join Table Schemas
Update all join table schemas:

**Files to modify:**
- `lib/game_master_core/characters/character_note_link.ex`
- `lib/game_master_core/characters/character_faction_link.ex`
- All other `*_link.ex` schema files

**Changes needed:**
```elixir
@primary_key {:id, :binary_id, autogenerate: true}
@foreign_key_type :binary_id

belongs_to :character, Character, type: :binary_id
belongs_to :note, Note, type: :binary_id
```

## 3. Remove Custom ID Generation

### 3.1 Delete ID Generator Module
- Remove `lib/game_master_core/id_generator.ex` entirely

### 3.2 Update Context Changesets
Remove custom ID generation from all context modules:

**Files to modify:**
- `lib/game_master_core/games.ex`
- `lib/game_master_core/characters.ex`
- `lib/game_master_core/factions.ex`
- `lib/game_master_core/locations.ex`
- `lib/game_master_core/notes.ex`
- `lib/game_master_core/quests.ex`

**Changes needed:**
```elixir
# Remove these lines from changeset functions:
|> put_change(:id, IdGenerator.generate_game_id())
|> put_change(:id, IdGenerator.generate_entity_id("character", game_id))

# Ecto will auto-generate UUIDs, no manual ID setting needed
```

## 4. Test Updates

### 4.1 Test Fixture Updates
Update all fixture files to remove manual ID generation:

**Files to modify:**
- `test/support/fixtures/games_fixtures.ex`
- `test/support/fixtures/characters_fixtures.ex`
- `test/support/fixtures/factions_fixtures.ex`
- `test/support/fixtures/locations_fixtures.ex`
- `test/support/fixtures/notes_fixtures.ex`
- `test/support/fixtures/quests_fixtures.ex`

**Changes needed:**
```elixir
# Remove any manual ID setting in fixtures
# UUIDs will be auto-generated by Ecto
```

### 4.2 Test Assertion Updates
Update hardcoded ID references in tests:

**Files to modify:**
- `test/game_master_core/characters_test.exs`
- `test/game_master_core/factions_test.exs`
- `test/game_master_core/locations_test.exs`
- `test/game_master_core/notes_test.exs`
- `test/game_master_core/quests_test.exs`
- All controller test files

**Changes needed:**
```elixir
# Before - hardcoded integer IDs for invalid tests
assert {:error, :character_not_found} = Locations.link_character(scope, location.id, 999)

# After - use invalid UUID format
assert {:error, :character_not_found} = 
  Locations.link_character(scope, location.id, "00000000-0000-0000-0000-000000000000")

# Or use Ecto.UUID.generate() for valid but non-existent UUIDs
invalid_uuid = Ecto.UUID.generate()
assert {:error, :character_not_found} = 
  Locations.link_character(scope, location.id, invalid_uuid)
```

### 4.3 Controller Test Updates
Update controller tests that reference entity IDs:

**Files to modify:**
- `test/game_master_core_web/controllers/character_controller_test.exs`
- All other controller test files

**Changes needed:**
```elixir
# Update any hardcoded ID references to use UUIDs
# Update JSON response assertions to expect UUID format
assert %{"id" => id} = json_response(conn, 201)["data"]
# id will now be a UUID string like "123e4567-e89b-12d3-a456-426614174000"
```

## 5. API Response Updates

### 5.1 Link Helper Updates
Update ID validation in link helpers:

**Files to modify:**
- `lib/game_master_core_web/controllers/link_helpers.ex`

**Changes needed:**
```elixir
# Before - custom string ID validation
def validate_entity_id(id) when is_binary(id) do
  case Regex.match?(~r/^(note|character|faction|location|quest)-\d+-\d+$/, id) do
    true -> :ok
    false -> {:error, "Invalid entity ID format"}
  end
end

# After - UUID validation
def validate_entity_id(id) when is_binary(id) do
  case Ecto.UUID.cast(id) do
    {:ok, _} -> :ok
    :error -> {:error, "Invalid entity ID format"}
  end
end
```

## 6. Swagger Documentation Updates

### 6.1 Update OpenAPI Schemas
Update all Swagger schema definitions:

**Files to modify:**
- `lib/game_master_core_web/controllers/character_controller.ex`
- All other controller files with `@doc` annotations
- Any dedicated schema files for OpenAPI

**Changes needed:**
```elixir
# Before - integer ID schemas
%Schema{
  type: :object,
  properties: %{
    id: %Schema{type: :integer},
    name: %Schema{type: :string}
  }
}

# After - UUID ID schemas  
%Schema{
  type: :object,
  properties: %{
    id: %Schema{type: :string, format: :uuid},
    name: %Schema{type: :string}
  }
}
```

### 6.2 Update Path Parameters
Update path parameter definitions:

```elixir
# Before
parameters: [
  id: [in: :path, description: "Character ID", type: :integer]
]

# After
parameters: [
  id: [in: :path, description: "Character ID", type: :string, format: :uuid]
]
```

## 7. Validation and Testing

### 7.1 Run Migration Tests
```bash
# Reset database and run migrations
mix ecto.drop
mix ecto.create  
mix ecto.migrate

# Run full test suite
mix test

# Generate updated Swagger docs
mix phx.swagger.generate
```

### 7.2 Verify API Responses
Test that all API endpoints return UUIDs in the correct format:
```json
{
  "data": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "type": "character",
    "name": "Aragorn"
  }
}
```

## 8. Estimated Effort

- **Database migrations**: 2-3 hours
- **Schema updates**: 3-4 hours  
- **Context/changeset cleanup**: 1-2 hours
- **Test updates**: 4-6 hours
- **Swagger documentation**: 2-3 hours
- **Testing and validation**: 2-3 hours

**Total estimated effort**: 14-21 hours

## 9. Benefits After Migration

- ✅ Globally unique IDs across all entity types
- ✅ No client-side ID collision issues
- ✅ Simplified backend (no custom ID generation)
- ✅ Better performance (no "scan all rows" operations)
- ✅ Standard UUID format for API consistency
- ✅ Ready for distributed systems if needed
